import React, { createContext, useContext, useState, useEffect, useCallback } from 'react'
import type { ReactNode } from 'react'
import { useUser } from './UserContext'
import * as favoritosService from '../services/favoritosService'
import type { Product } from '../types'

// ============================================
// TIPOS
// ============================================

interface FavoritosContextType {
  favoritos: Product[]
  loading: boolean
  addFavorite: (product: Product) => Promise<boolean | undefined>
  removeFavorite: (productId: number) => Promise<void>
  isFavorite: (productId: number) => boolean
  clearFavorites: () => Promise<void>
  count: number
  refreshFavorites: () => Promise<void>
  testarBancoDados: () => Promise<void>
  toggleFavorite: (product: Product) => Promise<{ action: string; is_favorito: boolean } | undefined>
}

// ============================================
// CONTEXTO
// ============================================

const FavoritosContext = createContext<FavoritosContextType | undefined>(undefined)

export const useFavoritos = () => {
  const context = useContext(FavoritosContext)
  if (context === undefined) {
    throw new Error('useFavoritos must be used within a FavoritosProvider')
  }
  return context
}

// ============================================
// PROVIDER
// ============================================

interface FavoritosProviderProps {
  children: ReactNode
}

export const FavoritosProvider: React.FC<FavoritosProviderProps> = ({ children }) => {
  const { user, isAuthenticated } = useUser()
  const [favoritos, setFavoritos] = useState<Product[]>([])
  const [loading, setLoading] = useState(false)


  // Converter FavoritoItem da API para Product
  const convertToProduct = (item: any): Product => {
    return {
      id: item.id_produto || item.id,
      nome: item.nome_produto || item.nome || '',
      preco: item.preco_promocional || item.preco_atual || item.preco || 0,
      precoAntigo: item.preco_original || item.preco_atual,
      imagem: item.imagem || '',
      categoria: item.categoria || '',
      descricao: item.descricao || '',
    }
  }

  // Buscar favoritos do banco de dados com fallback para localStorage
  const refreshFavorites = useCallback(async () => {
    if (!isAuthenticated || !user?.id) {
      setFavoritos([])
      return
    }

    try {
      setLoading(true)
      
      // TENTA PRIMEIRO O BANCO DE DADOS
      try {
        console.log('üîÑ Carregando favoritos do banco de dados...')
        const response = await favoritosService.buscarFavoritos(user.id)
        
        if (response.status && response.data?.favoritos) {
          const produtos = response.data.favoritos.map(convertToProduct)
          setFavoritos(produtos)
          
          // Atualiza localStorage tamb√©m
          const key = `favoritos_user_${user.id}`
          localStorage.setItem(key, JSON.stringify(produtos))
          
          console.log('‚úÖ Favoritos carregados do banco de dados:', produtos.length)
          return
        }
      } catch (apiError: any) {
        console.log('‚ö†Ô∏è Falha no banco, usando localStorage como fallback')
        console.error('Erro da API:', apiError)
      }
      
      // FALLBACK: Usar localStorage
      const key = `favoritos_user_${user.id}`
      const stored = localStorage.getItem(key)
      if (stored) {
        const produtos = JSON.parse(stored)
        setFavoritos(produtos)
        console.log('‚úÖ Favoritos carregados do localStorage:', produtos.length)
      } else {
        setFavoritos([])
        console.log('üìù Nenhum favorito encontrado')
      }
    } catch (error) {
      console.error('Erro ao buscar favoritos:', error)
      setFavoritos([])
    } finally {
      setLoading(false)
    }
  }, [isAuthenticated, user?.id])

  // Carregar favoritos quando o usu√°rio fizer login
  useEffect(() => {
    refreshFavorites()
  }, [refreshFavorites])

  // Alternar favorito (toggle) - M√âTODO PRINCIPAL
  const toggleFavorite = useCallback(async (product: Product) => {
    if (!isAuthenticated || !user?.id) {
      alert('Voc√™ precisa estar logado para usar favoritos')
      return
    }

    try {
      setLoading(true)
      
      // USA O ENDPOINT TOGGLE DA API
      try {
        console.log('üîÑ Alternando favorito no banco de dados...')
        const response = await favoritosService.alternarFavorito({
          id_usuario: user.id,
          id_produto: product.id
        })
        
        if (response.status && response.data) {
          const { action, is_favorito } = response.data
          
          if (action === 'added' || is_favorito) {
            // Produto foi adicionado
            if (!favoritos.some(p => p.id === product.id)) {
              const novosFavoritos = [...favoritos, product]
              setFavoritos(novosFavoritos)
              const key = `favoritos_user_${user.id}`
              localStorage.setItem(key, JSON.stringify(novosFavoritos))
            }
            console.log('‚úÖ Produto adicionado aos favoritos')
          } else {
            // Produto foi removido
            const novosFavoritos = favoritos.filter(p => p.id !== product.id)
            setFavoritos(novosFavoritos)
            const key = `favoritos_user_${user.id}`
            localStorage.setItem(key, JSON.stringify(novosFavoritos))
            console.log('‚úÖ Produto removido dos favoritos')
          }
          
          return { action, is_favorito }
        }
        
      } catch (apiError: any) {
        console.log('‚ö†Ô∏è Falha no banco, usando localStorage como fallback')
        console.error('Erro da API:', apiError)
        
        // FALLBACK: Toggle no localStorage
        const isFavorito = favoritos.some(p => p.id === product.id)
        let novosFavoritos
        
        if (isFavorito) {
          novosFavoritos = favoritos.filter(p => p.id !== product.id)
          console.log('‚úÖ Produto removido dos favoritos (localStorage)')
        } else {
          novosFavoritos = [...favoritos, product]
          console.log('‚úÖ Produto adicionado aos favoritos (localStorage)')
        }
        
        setFavoritos(novosFavoritos)
        const key = `favoritos_user_${user.id}`
        localStorage.setItem(key, JSON.stringify(novosFavoritos))
        
        return { action: isFavorito ? 'removed' : 'added', is_favorito: !isFavorito }
      }
      
    } catch (error: any) {
      console.error('Erro ao alternar favorito:', error)
      alert('Erro ao alterar favorito')
    } finally {
      setLoading(false)
    }
  }, [isAuthenticated, user?.id, favoritos])

  // Adicionar aos favoritos (compatibilidade)
  const addFavorite = useCallback(async (product: Product) => {
    const result = await toggleFavorite(product)
    return result?.action === 'added'
  }, [toggleFavorite])

  // Remover dos favoritos (compatibilidade)
  const removeFavorite = useCallback(async (productId: number) => {
    if (!isAuthenticated || !user?.id) {
      return
    }

    try {
      setLoading(true)
      
      // TENTA REMOVER DO BANCO PRIMEIRO
      try {
        console.log('üîÑ Tentando remover do banco de dados...')
        const response = await favoritosService.removerFavorito(user.id, productId)
        
        if (response.status) {
          console.log('‚úÖ Produto removido do banco de dados')
        }
      } catch (apiError: any) {
        console.log('‚ö†Ô∏è Falha no banco ao remover favorito')
        console.error('Erro da API:', apiError)
      }
      
      // Remove do localStorage tamb√©m
      const novosFavoritos = favoritos.filter(p => p.id !== productId)
      setFavoritos(novosFavoritos)
      const key = `favoritos_user_${user.id}`
      localStorage.setItem(key, JSON.stringify(novosFavoritos))
      
      console.log('‚úÖ Produto removido dos favoritos')
      
    } catch (error: any) {
      console.error('Erro ao remover favorito:', error)
      alert('Erro ao remover dos favoritos')
    } finally {
      setLoading(false)
    }
  }, [isAuthenticated, user?.id, favoritos])

  // Verificar se est√° nos favoritos
  const isFavorite = useCallback((productId: number) => {
    return favoritos.some(p => p.id === productId)
  }, [favoritos])

  // Limpar favoritos
  const clearFavorites = useCallback(async () => {
    if (!isAuthenticated || !user?.id) {
      return
    }

    try {
      setLoading(true)
      
      // Remove todos individualmente (n√£o h√° endpoint de limpar tudo)
      const promises = favoritos.map(produto => 
        favoritosService.removerFavorito(user.id, produto.id).catch(err => {
          console.log(`Erro ao remover produto ${produto.id}:`, err)
        })
      )
      
      await Promise.all(promises)
      console.log('‚úÖ Tentativa de limpeza no banco conclu√≠da')
      
      // Limpa localStorage
      setFavoritos([])
      const key = `favoritos_user_${user.id}`
      localStorage.removeItem(key)
      
      console.log('‚úÖ Favoritos limpos')
    } catch (error: any) {
      console.error('Erro ao limpar favoritos:', error)
      alert('Erro ao limpar favoritos')
    
  } catch (error: any) {
    console.error('Erro ao alternar favorito:', error)
    alert('Erro ao alterar favorito')
  } finally {
    setLoading(false)
  }
}, [isAuthenticated, user?.id, favoritos])

// Adicionar aos favoritos (compatibilidade)
const addFavorite = useCallback(async (product: Product) => {
  const result = await toggleFavorite(product)
  return result?.action === 'added'
}, [toggleFavorite])

// Remover dos favoritos (compatibilidade)
const removeFavorite = useCallback(async (productId: number) => {
  if (!isAuthenticated || !user?.id) {
    return
  }

    
    console.log(' Favoritos limpos')
  } catch (error: any) {
    console.error('Erro ao limpar favoritos:', error)
    alert('Erro ao limpar favoritos')
  } finally {
    setLoading(false)
  }
}, [isAuthenticated, user?.id, favoritos])

// Fun√ß√£o para testar integra√ß√£o completa com backend
const testarBancoDados = useCallback(async () => {
  if (!isAuthenticated || !user?.id) {
    console.log(' Usu√°rio n√£o autenticado')
    alert(' Voc√™ precisa estar logado para executar os testes')
    return
  }

  console.log(' === TESTE COMPLETO DE INTEGRA√á√ÉO COM BACKEND ===')
  console.log(` Usu√°rio: ${user.id}`)
  console.log(` Base URL: ${process.env.REACT_APP_API_URL || 'http://localhost:8080/v1/infohub'}`)
  
  const resultados = {
    buscarFavoritos: '‚ùå',
    adicionarFavorito: '‚ùå',
    alternarFavorito: '‚ùå',
    verificarFavorito: '‚ùå',
    removerFavorito: '‚ùå',
    contarFavoritos: '‚ùå',
    favoritosPromocao: '‚ùå'
  }

  try {
    // Teste 1: Buscar favoritos existentes
    console.log('\n TESTE 1: Buscando favoritos existentes...')
    try {
      const response = await favoritosService.buscarFavoritos(user.id)
      console.log(' Buscar favoritos: SUCESSO')
      console.log(' Dados recebidos:', response)
      console.log(` Total de favoritos: ${response.data?.total_favoritos || response.data?.favoritos?.length || 0}`)
      resultados.buscarFavoritos = '‚úÖ'
    } catch (error: any) {
      console.log(' Buscar favoritos: FALHA')
      console.log(' Erro:', error.response?.data || error.message)
    }

    // Teste 2: Contar favoritos
    console.log('\n TESTE 2: Contando favoritos...')
    try {
      const total = await favoritosService.contarFavoritos(user.id)
      console.log(' Contar favoritos: SUCESSO')
      console.log(` Total: ${total}`)
      resultados.contarFavoritos = '‚úÖ'
    } catch (error: any) {
      console.log(' Contar favoritos: FALHA')
      console.log(' Erro:', error.response?.data || error.message)
    }
    isFavorite,
    clearFavorites,
    count: favoritos.length,
    refreshFavorites,
    testarBancoDados,
    toggleFavorite
  }

  return (
    <FavoritosContext.Provider value={value}>
      {children}
    </FavoritosContext.Provider>
  )
}
